---
title: "Tímabundin vernd"
pagetitle: "Tímabundin vernd"
subtitle: "Hvað segja gögnin um fjölda hælisleitenda og fólksflutninga til Íslands?"
description: |
  Hér eru gögn um fjölda einstaklinga sem njóta tímabundinnar verndar, fjölda samþykktra verndarumsókna og fjölda umsókna í bið tekin saman úr gögnum  Eurostat.
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2023/01/18"
format: 
    html:
        code-fold: true
        smooth-scroll: true
        link-external-newwindow: true
        toc: true
        toc-location: right
        toc-title: Efnisyfirlit
editor: source
draft: false
title-block-banner: true
categories:
    - stjórnmál
    - fólksflutningar
href: greinar/flottafolk/index.qmd
image: Figures/vernd_saman_2_page.png
execute: 
  eval: true
---


```{r setup}
#| include: false
library(cowplot)
library(tidyverse)
library(scales)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(readxl)
library(janitor)
library(plotly)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(cowplot)
library(scales)
library(visitalaneysluverds)
library(feather)
library(gganimate)
library(metill)
library(patchwork)
library(arrow)
library(glue)
library(eurostat)
library(hagstofa)
library(crosstalk)
theme_set(theme_metill())
Sys.setlocale("LC_ALL", "is_IS.UTF-8")


caption <- "Mynd eftir @bggjonsson hjá metill.is byggð á gögnum OECD um fólksflutninga: https://stats.oecd.org/Index.aspx?DataSetCode=MIG\nGögn og kóði: https://github.com/bgautijonsson/Metill.is/tree/master/greinar/flottafolk"

litur_island <- "#08306b"
  
litur_danmork <- "#e41a1c"
  
litur_finnland <- "#3690c0"
  
litur_noregur <- "#7f0000"
  
litur_svithjod <- "#fd8d3c"
  
litur_annad <- "#737373"
  
```


```{r data_beneficiaries}
#| eval: false
beneficiaries <- get_eurostat(
  "migr_asytpsm", 
  cache = T,
  # update_cache = T,
  cache_dir = "data"
) |>
  filter(
    sex == "T",
    age == "TOTAL",
    citizen == "TOTAL"
  ) |> 
  select(-unit, -sex, -age, -citizen) |> 
  label_eurostat()
```


```{r data_pop}
#| eval: false
pop <- get_eurostat(
  "demo_pjan",
  cache = T,
  cache_dir = "data"
) |> 
  filter(
    age == "TOTAL",
    sex == "T"
  ) |> 
  select(-unit, -age, -sex) |> 
  label_eurostat()
```

```{r data_applicants}
#| eval: false
applicants <- get_eurostat(
  "migr_asypenctzm",
  cache = T,
  cache_dir = "data"
) |>
  janitor::remove_constant() |> 
  filter(
    age == "TOTAL",
    sex == "T",
    citizen == "TOTAL"
  ) |> 
  select(-citizen, -sex, -age) |> 
  label_eurostat()

```

```{r data_grants}
#| eval: false
grants <- get_eurostat(
  "migr_asytpfm",
  cache = T,
  cache_dir = "data"
) |> 
  filter(
    sex == "T",
    age == "TOTAL",
    citizen == "TOTAL"
  ) |> 
  select(-unit, -citizen, -sex, -age) |> 
  label_eurostat()
```

```{r data_decisions}
#| eval: false
decisions <- get_eurostat(
  "migr_asydcfstq",
  cache = TRUE,
  cache_dir = "data"
)  |> 
  filter(
    citizen == "TOTAL",
    sex == "T",
    age == "TOTAL",
    decision %in% c("TOTAL", "TOTAL_POS")
  ) |> 
  select(-citizen, -sex, -age, -unit) |> 
  label_eurostat() |> 
  pivot_wider(names_from = decision, values_from = values) |> 
  mutate(perc = `Total positive decisions` / Total) |> 
  select(geo, time, perc)
```


```{r data_merge}
#| eval: false
d <- beneficiaries |> 
  mutate(
    year = year(time)
  ) |> 
  rename(beneficiaries = values) |> 
  inner_join(
    pop |> 
      group_by(geo) |> 
      filter(time == max(time)) |> 
      ungroup() |> 
      select(geo, pop = values),
    by = c("geo")
  ) |> 
  full_join(
    applicants |> 
      rename(applicants = values),
    by = c("geo", "time")
  ) |> 
  inner_join(
    grants |> 
      rename(grants = values),
    by = c("geo", "time")
  ) |> 
  rename(country = geo) |> 
  mutate(
    country = ifelse(str_detect(country, "Germany"), "Germany", country)
  ) |> 
  inner_join(
    metill::country_names(),
    by = "country"
  ) |> 
  select(
    -year, -country
  ) |> 
  pivot_longer(
    c(-land, -time, -pop)
  ) |> 
  group_by(land) |> 
  mutate(pop = max(pop, na.rm = T)) |> 
  ungroup() |> 
  mutate(per_pop = value / pop * 1e3)

d |> 
  select(-value, -pop) |> 
  pivot_wider(names_from = name, values_from = per_pop) |> 
  rename(
    "Mánuður" = time,
    "Land" = land,
    "Fjöldi með vernd" = beneficiaries,
    "Umsækjendur" = applicants,
    "Veitt vernd í mánuði" = grants
  ) |> 
  write_csv("data/timabundin_vernd.csv")
```

# Um gögnin

Gögn þessarar úrvinnslu koma frá [Eurostat](https://ec.europa.eu/eurostat/en/), nánar tiltekið eru þetta þrjú gagnasöfn:

* [Ákvarðanir í málum um tímabundnavernd eftir mánuði](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPFM/default/table?lang=en&category=migr.migr_asy.migr_asytp)
* [Umsækjendur í bið eftir niðurstöðu í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/TPS00190/default/table?lang=en&category=migr.migr_asy.migr_asyapp)
* [Einstaklingar sem njóta tímabundinnar verndar í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPSM/default/table?lang=en&category=migr.migr_asy.migr_asytp)

Þessari upplýsingar eru svo tengdar við [gögn um mannfjölda hvers lands](https://ec.europa.eu/eurostat/databrowser/view/demo_pjan/default/table?lang=en).

Til að auðvelda samanburð milli landa eru allar tölur sýndar sem fjöldi á hverja 1.000 íbúa hvers lands.

## Umsækjendur

Fyrst skoðum við hversu margir umsækjendur eru að bíða eftir niðurstöðu í sínu máli á hverri stundu.

```{r umsaek}
#| eval: false
p1 <- d |> 
  filter(
    name == "applicants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended(),
    limits = c(0, 3.2)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/umsaek_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "applicants") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(month(dags) == 11) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 5.5)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = "Fjöldi í nóvember 2022",
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/umsaek_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "applicants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter(month(dags) <= 11) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup() |> 
      mutate(
        value = case_when(
          # land == "Svíþjóð" ~ value - 0.8,
          # land == "Ísland" ~ value - 0.2,
          # land == "Noregur" ~ value + 0.3,
          # land == "Danmörk" ~ value + 1,
          # land == "Finnland" ~ value + 0.5,
          TRUE ~ value
        )
      ),
    aes(label = land, colour = colour),
    hjust = 0,
    nudge_x = 10,
    box.padding = 0.1,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    labels = label_date(format = "%B")
  ) +
  geom_rangeframe(sides = "b") +
  scale_y_tufte(
    breaks = tufte_breaks(plot_dat$value),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion()
  ) +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    axis.line.x = element_blank(),
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = "Sýnt sem fjöldi á 1.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/umsaek_saman_2.png){.column-page}

## Veitingar

Skoðum svo hversu mörgum er veitt tímabundin vernd í hverjum mánuði.

```{r akvard}
#| eval: false
p1 <- d |> 
  filter(
    name == "grants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |>
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/akvard_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "grants") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(month(dags) == 11) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 1.1)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd?",
    subtitle = "Fjöldi í nóvember 2022",
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/akvard_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvað er mörgum veitt tímabundin vernd?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "grants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter(month(dags) <= 11) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup() |> 
      mutate(
        value = case_when(
          # land == "Svíþjóð" ~ value - 0.8,
          # land == "Ísland" ~ value - 0.2,
          # land == "Noregur" ~ value + 0.3,
          # land == "Danmörk" ~ value + 1,
          # land == "Finnland" ~ value + 0.5,
          TRUE ~ value
        )
      ),
    aes(label = land, colour = colour),
    hjust = 0,
    nudge_x = 10,
    box.padding = 0.1,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    labels = label_date(format = "%B")
  ) +
  geom_rangeframe(sides = "b") +
  scale_y_tufte(
    breaks = tufte_breaks(plot_dat$value),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion()
  ) +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, 5), clip = "on") +
  theme(
    axis.line.x = element_blank(),
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvað er mörgum veitt tímabundin vernd?",
    subtitle = "Sýnt sem fjöldi á 1.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/akvard_saman_2.png){.column-page}

## Vernd

Hér skoðum við svo fjölda fólks í landinu sem nýtur tímabundinnar verndar hverri stundu.

```{r vernd}
#| eval: false
p1 <- d |> 
  filter(
    name == "beneficiaries"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 20)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/vernd_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "beneficiaries") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(month(dags) == 11) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 30)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Fjöldi í nóvember 2022",
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/vernd_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "beneficiaries") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter(month(dags) <= 11) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup() |> 
      mutate(
        value = case_when(
          # land == "Svíþjóð" ~ value - 0.8,
          # land == "Ísland" ~ value - 0.2,
          # land == "Noregur" ~ value + 0.3,
          # land == "Danmörk" ~ value + 1,
          # land == "Finnland" ~ value + 0.5,
          TRUE ~ value
        )
      ),
    aes(label = land, colour = colour),
    hjust = 0,
    nudge_x = 10,
    box.padding = 0.1,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    labels = label_date(format = "%B")
  ) +
  geom_rangeframe(sides = "b") +
  scale_y_tufte(
    breaks = tufte_breaks(plot_dat$value),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion()
  ) +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    axis.line.x = element_blank(),
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Sýnt sem fjöldi á 1.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

ggsave(
  plot = p &
    theme(
      plot.background = element_blank(),
      panel.background = element_blank()
    ),
  filename = "Figures/vernd_saman_2_page.png",
  width = 8, height = 0.621 * 8, scale = 1.3
)
```

![](Figures/vernd_saman_2.png){.column-page}

# Hlutfall erlendra ríkisborgara eftir sveitarfélagi

Hér getum við notað gögn Hagstofu um [Mannfjöldi eftir sveitarfélögum, kyni, ríkisfangi og ársfjórðungum 2010-2022](https://px.hagstofa.is/pxis/pxweb/is/Ibuar/Ibuar__mannfjoldi__2_byggdir__sveitarfelog/MAN10001.px). Til að vera viss um hvað sé skilgreint sem íslenskur/erlendur ríkisborgari skoðum við [lýsigögn Hagstofu um mannfjölda tölur](https://hagstofa.is/utgafur/lysigogn/lysigogn/?fileId=19525):

> Ríkisfangsland: Með ríkisfangslandi er átt við Ísland ef barn er fætt af íslensku foreldri. Að öðru leyti er miðað við hvaða ríki hefur gefið út vegabréf það eða skilríki sem viðkomandi hefur framvísað við skráningu í Þjóðskrá.
>
> - Hagstofa Íslands

```{r}
url <- "https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/2_byggdir/sveitarfelog/MAN10001.px"

d <- hg_data(url) |> 
  filter(
    `Kyn og ríkisfang` %in% c("Alls", "Erl. ríkisborgarar")
  ) |> 
  collect() |> 
  janitor::clean_names() |> 
  mutate(sveitarfelag = str_squish(sveitarfelag)) |> 
  rename(value = 4) |> 
  separate(
    arsfjordungur, into = c("ar", "man"), sep = "Á", convert = TRUE
  ) |> 
  mutate(dags = clock::date_build(ar, man)) |> 
  select(dags, sveitarfelag, kyn_og_rikisfang, value) |> 
  pivot_wider(names_from = kyn_og_rikisfang) |> 
  janitor::clean_names() |>
  mutate(hlutf = erl_rikisborgarar / alls)
```


```{r}
plotly_color <- "#b30000"
  
start_dags <- min(d$dags)

plot_dat <- d |> 
  filter(
    str_detect(
      str_to_lower(sveitarfelag),
      "reykjaví|garðab|kópav|hafnarf|mosf|seltjar|akrane|akureyr|fjarðab|árbo|múlaþ|vestman|borgarbygg|ísafjarð|suðurnes|grindaví|norðurþ|hverag|ölfus|hornafj|reykjane"
    )
  ) |> 
  mutate(
    order_var = hlutf[dags == max(dags)],
    .by = sveitarfelag
  ) |> 
  mutate(
    sveitarfelag = fct_reorder(sveitarfelag, order_var)
  ) |> 
  mutate(
    hlutf_latest = ifelse(dags == max(dags), hlutf, NA_real_),
    var1 = glue("% innflytjenda ({format(max(d$dags), '%d. %B %Y')})"),
    var2 = "% innflytjenda eftir ári",
    text1 = str_c(
      "<b>", sveitarfelag, "</b>", "\n",
      "Innfæddir íbúar: ", number(alls - erl_rikisborgarar, big.mark = ".", decimal.mark = ","), "\n",
      "Innfluttir íbúar: ", number(erl_rikisborgarar, big.mark = ".", decimal.mark = ","), "\n",
      "% innflutt: ", hlutf(hlutf_latest, accuracy = 0.1)
    ),
    text2 = str_c(
      "<b>", sveitarfelag, "</b>", "\n",
      "Dagsetning: ", dags, "\n",
      "Innfæddir íbúar: ", number(alls - erl_rikisborgarar, big.mark = ".", decimal.mark = ","), "\n",
      "Innfluttir íbúar: ", number(erl_rikisborgarar, big.mark = ".", decimal.mark = ","), "\n",
      "% innflutt: ", hlutf(hlutf, accuracy = 0.1)
    )
  )

pd <- highlight_key(
  plot_dat, 
  ~sveitarfelag, 
  "Veldu sveitarfélag með nafni eða smelltu á myndirnar <i>(Haltu inni SHIFT til að velja fleiri)</i>"
)
```


```{r}
p1 <- pd |>
  ggplot(aes(hlutf_latest, sveitarfelag, text = text1)) +
  geom_point(
    size = 2
  ) +
  geom_segment(
    aes(yend = sveitarfelag, xend = 0),
    alpha = 1,
    size = 0.1
  ) +
  scale_x_continuous(
    labels = label_hlutf(accuracy = 1),
    limits = c(0, 0.31),
    expand = expansion()
  ) +
  theme(
    strip.text = element_text(margin = margin(3, 3, 3, 3))
  ) +
  labs(
    x = NULL,
    y = NULL
  ) +
  facet_wrap("var1")
```

```{r}
p2 <- pd |> 
  ggplot(aes(dags, hlutf, text = text2)) +
  geom_line(aes(group = sveitarfelag)) +
  scale_x_date(
    expand = expansion()
  ) +
  scale_y_continuous(
    labels = label_hlutf(accuracy = 1),
    expand = expansion(),
    limits = c(0, 0.31)
  ) +
  theme(
    strip.text = element_text(margin = margin(3, 3, 3, 3))
  ) +
  labs(
    x =  "",
    y = NULL
  ) +
  facet_wrap("var2")

```

<div class='column-screen-inset' style='position:relative;left:5%;width:90%;'>

```{r}
#| fig-asp: 1

subplot(
  metill_ggplotly(p1, tooltip = "text"),
  metill_ggplotly(p2, tooltip = "text"),
  widths = c(0.25, 0.75),
  nrows = 1,
  shareX = F,
  shareY = F,
  titleX = T,
  titleY = T
) |>
  layout(
    margin = list(
      l = 100
    )
  ) |> 
  highlight(
    on = "plotly_click",
    defaultValues = "Reykjavíkurborg",
    persistent = FALSE,
    color = plotly_color,
    selectize = TRUE
  )
```

</div>


# Lengd dvalar

```{r}
url <- "https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/3_bakgrunnur/Uppruni/MAN43007.px"

d <- hg_data(url) |> 
  filter(
    Kyn == "Alls",
    `Lengd dvalar` != "Alls",
  ) |> 
  collect() |> 
  janitor::clean_names() |> 
  select(-kyn) |> 
  rename(value = 4) |> 
  mutate(
    ar = parse_number(ar),
    hlutf = value / sum(value),
    .by = c(ar, sveitarfelag)
  ) |> 
  mutate(
    lengd_dvalar = ifelse(lengd_dvalar == "1-2 tvö ár", "1-2 ár", lengd_dvalar),
    lengd_dvalar = fct_relevel(
      lengd_dvalar,
      "Innan við ár",
      "1-2 ár",
      "3-5 ár",
      "6-10 ár",
      "11 ár og lengur"
    )
  )
```

```{r}
#| eval: false
plot_dat <- d |> 
  filter(
    # sveitarfelag == "Alls"
  )

pd <- highlight_key(plot_dat)

p <- pd |> 
  ggplot(aes(ar, hlutf, fill = lengd_dvalar, col = lengd_dvalar)) +
  geom_area(position = "stack") +
  scale_x_continuous(
    expand = expansion()
  ) +
  scale_y_continuous(
    expand = expansion(),
    labels = label_hlutf(accuracy = 1)
  )

bscols(
  filter_select(
    "id", 
    "Veldu sveitarfélag", 
    pd,
    ~sveitarfelag, 
    allLevels = FALSE,
    multiple = FALSE
  ),
  (
    pd |> 
      ggplot(aes(ar, hlutf, fill = lengd_dvalar, col = lengd_dvalar)) +
      geom_area(position = "fill") +
      scale_x_continuous(
        expand = expansion()
      ) +
      scale_y_continuous(
        expand = expansion(),
        labels = label_hlutf(accuracy = 1)
      )
  ) |> 
    metill_ggplotly(dynamicTicks = FALSE, originalData = FALSE),
  widths = c(12, 12)
)
```





