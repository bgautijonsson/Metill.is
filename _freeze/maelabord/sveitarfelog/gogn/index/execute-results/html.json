{
  "hash": "1b64d1c2b6f2449d84bc834ec68c90f6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Ársreikningar sveitarfélaga\"\nsubtitle: \"Hvernig eru ársreikningagögn sveitarfélaga undirbúin fyrir birtingu í mælaborði Metils um?\"\nauthor: \n    -   name: \"Brynjólfur Gauti Guðrúnar Jónsson\"\n        url: \"https://twitter.com/bgautijonsson\"\n        affiliation: \"Tölfræði, Raunvísindadeild Háskóla Íslands\"\n        affiliation-url: \"https://www.hi.is/tolfraedi_0\"\ndate: \"2023/04/13\"\nformat: \n    html:\n        code-fold: show\n        smooth-scroll: true\n        link-external-newwindow: true\n        toc: true\n        toc-location: right\neditor: source\ndraft: false\ntitle-block-banner: true\ncategories:\n    - stjórnmál\n    - efnahagur\n    - ársreikningar\n    - sveitarfélög\nexecute: \n  echo: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(visitalaneysluverds)\nlibrary(hagstofa)\nlibrary(arrow)\nlibrary(googledrive)\nlibrary(googlesheets4)\n```\n:::\n\n\n## Mannfjöldi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/2_byggdir/sveitarfelog/MAN02005.px\"\nmannfjoldi <- hg_data(url) |> \n  filter(\n    Aldur == \"Alls\",\n    Kyn == \"Alls\",\n    Sveitarfélag != \"Alls\"\n  ) |> \n  collect() |> \n  clean_names() |> \n  rename(mannfjoldi = 5) |> \n  select(-aldur, -kyn) |> \n  mutate(ar = parse_number(ar))\n```\n:::\n\n\n## Efnahagur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nefnahagur <- read_excel(\"net-efnahagsreikningar.xlsx\", skip = 4) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti) |> \n  filter(\n    tegund2 %in% c(\n      \"Veltufjármunir Total\", \n      \"Varanlegir rekstrarfjármunir\", \n      \"Áhættufjármunir og langtímakröfur\",\n      \"Skuldbindingar\", \n      \"Langtímaskuldir\",\n      \"Skammtímaskuldir\", \n      \"Eigið fé\"\n    ) | tegund %in% c(\n      \"Skammtímakröfur á eigin fyrirtæki\",\n      \"Aðrir veltufjármunir\"\n    )\n  ) |> \n  mutate(\n    tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |>\n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  )\n```\n:::\n\n\n\n## Rekstur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrekstur <- read_excel(\"net-rekstrarreikningar.xlsx\", skip = 5) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti) |> \n  filter(\n    tegund2 %in% c(\n      \"Gjöld Total\", \n      \"Tekjur Total\",\n      \"Rekstrarniðurstaða Total\"\n    ) | tegund %in% c(\n      \"Afskriftir\", \n      \"Breyting lífeyrisskuldbindinga\",\n      \"Fjármagnsliðir\",\n      \"Óreglulegir liðir\",\n      \"Framlag Jöfnunarsjóðs\", \n      \"Skatttekjur án Jöfnunarsjóðs\",\n      \"Laun og launatengd gjöld\"\n    )\n  ) |> \n  mutate(\n    tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |> \n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  )\n```\n:::\n\n\n\n\n## Sjóðsstreymi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsjodsstreymi <- read_excel(\"net-sjodstreymi.xlsx\", skip = 4) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti, tegund2) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  ) |> \n  filter(\n    tegund2 %in% c(\n      \"Veltufé frá rekstri Total\", \n      \"Fjárfestingarhreyfingar Total\") | \n      tegund %in% c(\n        \"Afborganir langtímalána\",\n        \"Aðrar fjármögnunarhreyfingar\",\n        \"Tekin ný langtímalán\",\n        \"Fjárfesting í varanlegum rekstrarfjármunum\"\n      )\n  ) |>\n  mutate(\n    tegund2 = ifelse(is.na(tegund), tegund2, tegund) |>\n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    total = coalesce(total, 0)\n  )\n```\n:::\n\n\n\n## Tenging\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- efnahagur |> \n  select(-tegund3) |> \n  pivot_wider(names_from = tegund2, values_from = total) |> \n  inner_join(\n    rekstur |> \n      pivot_wider(names_from = tegund2, values_from = total),\n    by = c(\"ar\", \"sveitarfelag\", \"hluti\")\n  ) |> \n  inner_join(\n    sjodsstreymi |> \n      pivot_wider(names_from = tegund2, values_from = total),\n    by = c(\"ar\", \"sveitarfelag\", \"hluti\")\n  ) |> \n  mutate_at(\n    vars(-ar, -sveitarfelag, -hluti),\n    coalesce, 0\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  skimr::skim()\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |     |\n|:------------------------|:----|\n|Name                     |d    |\n|Number of rows           |3074 |\n|Number of columns        |28   |\n|_______________________  |     |\n|Column type frequency:   |     |\n|character                |2    |\n|numeric                  |26   |\n|________________________ |     |\n|Group variables          |None |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|sveitarfelag  |         0|             1|   8|  29|     0|       81|          0|\n|hluti         |         0|             1|   7|  12|     0|        2|          0|\n\n\n**Variable type: numeric**\n\n|skim_variable                              | n_missing| complete_rate|       mean|         sd|        p0|        p25|      p50|        p75|      p100|hist  |\n|:------------------------------------------|---------:|-------------:|----------:|----------:|---------:|----------:|--------:|----------:|---------:|:-----|\n|ar                                         |         0|             1|    2011.80|        6.0|      2002|    2007.00|   2012.0|    2017.00|      2022|▇▆▆▆▆ |\n|Varanlegir rekstrarfjármunir               |         0|             1| 6979922.86| 38207765.1|      5116|  288631.25| 828232.0| 3003434.50| 777286753|▇▁▁▁▁ |\n|Áhættufjármunir og langtímakröfur          |         0|             1|  866860.21|  3125471.9|         0|   52849.50| 137816.5|  444522.00|  36071319|▇▁▁▁▁ |\n|Skammtímakröfur á eigin fyrirtæki          |         0|             1|   60827.04|   181203.1|   -303230|       0.00|      0.0|   42727.75|   3842587|▇▁▁▁▁ |\n|Aðrir veltufjármunir                       |         0|             1|  415304.38|  1859983.0|         0|   21567.00|  68442.0|  185690.25|  32992652|▇▁▁▁▁ |\n|Veltufjármunir                             |         0|             1| 1024043.90|  4190330.9|      5481|   92999.50| 204343.0|  612781.00|  83647325|▇▁▁▁▁ |\n|Eigið fé                                   |         0|             1| 3578802.58| 19949924.4|  -1705566|  245907.50| 547618.5| 1541712.00| 423955128|▇▁▁▁▁ |\n|Skuldbindingar                             |         0|             1|  969607.66|  3902422.6|         0|       0.00|  59325.0|  461501.75|  64425813|▇▁▁▁▁ |\n|Langtímaskuldir                            |         0|             1| 3419319.72| 18569470.8|         0|   63551.50| 356598.5| 1203402.00| 318672356|▇▁▁▁▁ |\n|Skammtímaskuldir                           |         0|             1|  903097.08|  3716030.4|       205|   44563.25| 148725.0|  419417.25|  63279417|▇▁▁▁▁ |\n|Skatttekjur án Jöfnunarsjóðs               |         0|             1| 2256710.78|  8552213.6|      7636|  139961.00| 376073.5| 1173597.25| 118591219|▇▁▁▁▁ |\n|Framlag Jöfnunarsjóðs                      |         0|             1|  374381.05|   776538.4|         0|   65617.00| 158242.0|  350731.62|  10608300|▇▁▁▁▁ |\n|Tekjur                                     |         0|             1| 3612082.00| 13856936.6|     12600|  272856.25| 697090.0| 2002404.25| 223426232|▇▁▁▁▁ |\n|Laun og launatengd gjöld                   |         0|             1| 1769052.47|  6657036.9|       874|  119626.50| 341346.0| 1038470.50| 106354668|▇▁▁▁▁ |\n|Breyting lífeyrisskuldbindinga             |         0|             1|  111323.46|   598052.3|  -1531587|       0.00|   4059.5|   41598.75|  14666288|▇▁▁▁▁ |\n|Afskriftir                                 |         0|             1|  226047.49|  1251172.5|         0|   11541.00|  31914.0|   95465.00|  23515214|▇▁▁▁▁ |\n|Gjöld                                      |         0|             1| 3406030.38| 12957551.1|     13862|  267520.75| 671245.5| 1912136.25| 208284956|▇▁▁▁▁ |\n|Fjármagnsliðir                             |         0|             1| -197600.54|  2138598.6| -99783794|  -63849.00| -11052.5|    2208.28|  10505376|▁▁▁▁▇ |\n|Óreglulegir liðir                          |         0|             1|   53661.58|   767339.8|  -6171386|       0.00|      0.0|       0.00|  20174498|▁▇▁▁▁ |\n|Rekstrarniðurstaða                         |         0|             1|   62112.65|  1826034.7| -71495906|  -18528.50|   9486.0|   64070.00|  28027176|▁▁▁▇▁ |\n|Veltufé frá rekstri                        |         0|             1|  419850.55|  2153715.6|  -2583086|   13808.25|  54884.0|  213400.75|  39602982|▇▁▁▁▁ |\n|Fjárfesting í varanlegum rekstrarfjármunum |         0|             1| -544965.25|  2805292.7| -50849042| -229539.00| -61410.5|  -14637.50|   1599022|▁▁▁▁▇ |\n|Fjárfestingarhreyfingar                    |         0|             1| -405456.65|  2478335.2| -48811242| -195496.40| -45418.0|   -5200.25|  29084625|▁▁▁▇▁ |\n|Tekin ný langtímalán                       |         0|             1|  410045.81|  2191577.9|   -170501|       0.00|  12943.5|  142847.25|  44594536|▇▁▁▁▁ |\n|Afborganir langtímalána                    |         0|             1| -338703.62|  1599787.1| -28501261| -149641.25| -44641.0|   -7611.25|     94019|▁▁▁▁▇ |\n|Aðrar fjármögnunarhreyfingar               |         0|             1|  -40890.86|   434026.4| -10357497|  -18805.25|      0.0|    3013.00|   2709554|▁▁▁▇▁ |\n\n\n:::\n:::\n\n\n### Sameining sveitarfélaga \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmulathing <- c(\n  \"Múlaþing\", \n  \"Fljótsdalshérað\", \n  \"Seyðisfjarðarkaupstaður\",\n  \"Borgarfjarðarhreppur\",\n  \"Djúpavogshreppur\"\n)\n\nsudurnesjabaer <- c(\n  \"Sandgerðisbær\", \n  \"Sveitarfélagið Garður\"\n)\n\nfjardabyggd <- c(\n  \"Breiðdalshreppur\",\n  \"Fjarðabyggð\"\n)\n\ngardabaer <- c(\n  \"Sveitarfélagið Álftanes\", \n  \"Garðabær\"\n)\n\nd <- d |> \n  mutate(\n    sveitarfelag = case_match(\n      sveitarfelag,\n      mulathing ~ \"Múlaþing\",\n      sudurnesjabaer ~ \"Suðurnesjabær\",\n      fjardabyggd ~ \"Fjarðabyggð\",\n      gardabaer ~ \"Garðabær\",\n      sveitarfelag ~ sveitarfelag\n    )\n  )\n```\n:::\n\n\n\n## Reikna breytur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> mutate(\n  heildarskuldir = `Skuldbindingar` + `Langtímaskuldir` + `Skammtímaskuldir`,\n  eignir = `Varanlegir rekstrarfjármunir` + `Áhættufjármunir og langtímakröfur` + `Veltufjármunir`\n)\n\nd\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3,074 × 30\n      ar sveitarfelag        hluti Varanlegir rekstrarf…¹ Áhættufjármunir og l…²\n   <dbl> <chr>               <chr>                  <dbl>                  <dbl>\n 1  2022 Reykjavíkurborg     A_hl…             200279038.              24589047.\n 2  2022 Reykjavíkurborg     A_og…             777286753.              21203607.\n 3  2022 Kópavogsbær         A_hl…              54831077                5865042 \n 4  2022 Kópavogsbær         A_og…              81524112                2674309 \n 5  2022 Seltjarnarnesbær    A_hl…               6775005                2475607 \n 6  2022 Seltjarnarnesbær    A_og…               8669016                1744887 \n 7  2022 Garðabær            A_hl…              36530755                6797479 \n 8  2022 Garðabær            A_og…              43500880                7483699 \n 9  2022 Hafnarfjarðarkaups… A_hl…              47499673                6124462 \n10  2022 Hafnarfjarðarkaups… A_og…              68615095                5241519 \n# ℹ 3,064 more rows\n# ℹ abbreviated names: ¹​`Varanlegir rekstrarfjármunir`,\n#   ²​`Áhættufjármunir og langtímakröfur`\n# ℹ 25 more variables: `Skammtímakröfur á eigin fyrirtæki` <dbl>,\n#   `Aðrir veltufjármunir` <dbl>, Veltufjármunir <dbl>, `Eigið fé` <dbl>,\n#   Skuldbindingar <dbl>, Langtímaskuldir <dbl>, Skammtímaskuldir <dbl>,\n#   `Skatttekjur án Jöfnunarsjóðs` <dbl>, `Framlag Jöfnunarsjóðs` <dbl>, …\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  select(\n    ar, \n    sveitarfelag,\n    hluti,\n    heildarskuldir,\n    eignir,\n    tekjur = \"Tekjur\", \n    skatttekjur_an_jofnundarsjods = \"Skatttekjur án Jöfnunarsjóðs\",\n    framlag_jofnunarsjods = \"Framlag Jöfnunarsjóðs\",\n    gjold = \"Gjöld\", \n    afskriftir = \"Afskriftir\",\n    fjarmagnslidir = \"Fjármagnsliðir\", \n    oreglulegir_lidir = \"Óreglulegir liðir\",\n    rekstrarnidurstada = \"Rekstrarniðurstaða\",\n    breyting_lifeyrisskuldbindinga = \"Breyting lífeyrisskuldbindinga\",\n    afborganir_langtimalana = \"Afborganir langtímalána\",\n    tekin_ny_langtimalan = \"Tekin ný langtímalán\",\n    adrar_fjarmognunarhreyfingar = \"Aðrar fjármögnunarhreyfingar\",\n    ny_fjarfesting = \"Fjárfesting í varanlegum rekstrarfjármunum\",\n    eigid_fe = \"Eigið fé\", \n    veltufjarmunir = \"Veltufjármunir\", \n    skammtimakrofur_eigin_fyrirtaeki = \"Skammtímakröfur á eigin fyrirtæki\",\n    handbaert_fe = \"Aðrir veltufjármunir\",\n    skammtimaskuldir = \"Skammtímaskuldir\", \n    fjarfestingarhreyfingar = \"Fjárfestingarhreyfingar\", \n    nyjar_langtimaskuldir = \"Tekin ný langtímalán\",\n    launagjold = \"Laun og launatengd gjöld\",\n    veltufe = \"Veltufé frá rekstri\"\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  group_by(sveitarfelag, ar, hluti) |> \n  summarise_at(\n    vars(heildarskuldir:veltufe), \n    ~ 1000 * sum(.x)\n  ) |> \n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  mutate(\n    hluti = fct_recode(\n      hluti,\n      \"A-hluti\" = \"A_hluti\",\n      \"A og B-hluti\" = \"A_og_B_hluti\"\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  inner_join(\n    mannfjoldi,\n    by = join_by(ar, sveitarfelag)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |>\n  mutate(\n    eiginfjarhlutfall = eigid_fe / eignir,\n    framlegd = tekjur - gjold + afskriftir,\n    framlegd_hlutf = framlegd / tekjur,\n    handbaert_fe_per_ibui = handbaert_fe / mannfjoldi,\n    heildarskuldir = heildarskuldir,\n    launagjold_per_ibui = launagjold / mannfjoldi,\n    launagjold_hlutf_gjold = launagjold / gjold,\n    nettoskuldir = heildarskuldir - veltufjarmunir + skammtimakrofur_eigin_fyrirtaeki,\n    nettoskuldir_hlutf_tekjur = nettoskuldir / tekjur,\n    rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,\n    rekstur_3_ar = rekstrarnidurstada + lag(rekstrarnidurstada, 1) + lag(rekstrarnidurstada, 2),\n    tekjur_3_ar = tekjur + lag(tekjur, 1) + lag(tekjur, 2),\n    rekstur_3_ar_hlutf_tekjur = rekstur_3_ar / tekjur_3_ar,\n    skattur_a_ibua = skatttekjur_an_jofnundarsjods / mannfjoldi,\n    skuldahlutfall = 1 - eiginfjarhlutfall,\n    skuldir_hlutf_tekjur = heildarskuldir / tekjur,\n    skuldir_per_ibui = heildarskuldir / mannfjoldi,\n    veltufe_hlutf_tekjur = veltufe / tekjur,\n    veltufjarhlutfall = veltufjarmunir / skammtimaskuldir,\n    veltufe_hlutf_afborganir = veltufe / afborganir_langtimalana,\n    fjarf_nylan = tekin_ny_langtimalan - ny_fjarfesting,\n    fjarfesting_hlutf_skuldir = fjarf_nylan / heildarskuldir,\n    .by = c(sveitarfelag, hluti)\n  )\n\nd |> \n  write_parquet(\n    \"total_data.parquet\"\n  )\n\nnames(d)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"sveitarfelag\"                     \"ar\"                              \n [3] \"hluti\"                            \"heildarskuldir\"                  \n [5] \"eignir\"                           \"tekjur\"                          \n [7] \"skatttekjur_an_jofnundarsjods\"    \"framlag_jofnunarsjods\"           \n [9] \"gjold\"                            \"afskriftir\"                      \n[11] \"fjarmagnslidir\"                   \"oreglulegir_lidir\"               \n[13] \"rekstrarnidurstada\"               \"breyting_lifeyrisskuldbindinga\"  \n[15] \"afborganir_langtimalana\"          \"tekin_ny_langtimalan\"            \n[17] \"adrar_fjarmognunarhreyfingar\"     \"ny_fjarfesting\"                  \n[19] \"eigid_fe\"                         \"veltufjarmunir\"                  \n[21] \"skammtimakrofur_eigin_fyrirtaeki\" \"handbaert_fe\"                    \n[23] \"skammtimaskuldir\"                 \"fjarfestingarhreyfingar\"         \n[25] \"nyjar_langtimaskuldir\"            \"launagjold\"                      \n[27] \"veltufe\"                          \"mannfjoldi\"                      \n[29] \"eiginfjarhlutfall\"                \"framlegd\"                        \n[31] \"framlegd_hlutf\"                   \"handbaert_fe_per_ibui\"           \n[33] \"launagjold_per_ibui\"              \"launagjold_hlutf_gjold\"          \n[35] \"nettoskuldir\"                     \"nettoskuldir_hlutf_tekjur\"       \n[37] \"rekstrarnidurstada_hlutf\"         \"rekstur_3_ar\"                    \n[39] \"tekjur_3_ar\"                      \"rekstur_3_ar_hlutf_tekjur\"       \n[41] \"skattur_a_ibua\"                   \"skuldahlutfall\"                  \n[43] \"skuldir_hlutf_tekjur\"             \"skuldir_per_ibui\"                \n[45] \"veltufe_hlutf_tekjur\"             \"veltufjarhlutfall\"               \n[47] \"veltufe_hlutf_afborganir\"         \"fjarf_nylan\"                     \n[49] \"fjarfesting_hlutf_skuldir\"       \n```\n\n\n:::\n:::\n\n\n# Þróunargögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\npercent_vars <- c(\n  \"Eiginfjárhlutfall\",\n  \"Framlegð sem hlutfall af tekjum\",\n  \"Handbært fé á íbúa\",\n  \"Launa- og launatengd gjöld sem hlutfall af útgjöldum\",\n  \"Nettóskuldir sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\",\n  \"Skuldahlutfall\",\n  \"Skuldir sem hlutfall af tekjum\",\n  \"Veltufé frá rekstri sem hlutfall af tekjum\",\n  \"Veltufjárhlutfall\"\n)\n\nthroun_data <- d |> \n  select(\n    sveitarfelag,\n    ar,\n    hluti,\n    \"Heildarskuldir\" = heildarskuldir,\n    # \"Eignir\" = eignir,\n    # \"Tekjur\" = tekjur,\n    # \"Rekstrarniðurstaða\" = rekstrarnidurstada,\n    \"Eiginfjárhlutfall\" = eiginfjarhlutfall,\n    \"Framlegð sem hlutfall af tekjum\" = framlegd_hlutf,\n    \"Handbært fé á íbúa\" = handbaert_fe_per_ibui,\n    \"Launa- og launatengd gjöld á íbúa\" = launagjold_per_ibui,\n    \"Launa- og launatengd gjöld sem hlutfall af útgjöldum\" = launagjold_hlutf_gjold,\n    \"Nettóskuldir sem hlutfall af tekjum\" = nettoskuldir_hlutf_tekjur,\n    \"Rekstrarniðurstaða sem hlutfall af tekjum\" = rekstrarnidurstada_hlutf,\n    \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\" = rekstur_3_ar_hlutf_tekjur,\n    \"Útsvar og fasteignaskattur á íbúa\" = skattur_a_ibua,\n    \"Skuldahlutfall\" = skuldahlutfall,\n    \"Skuldir sem hlutfall af tekjum\" = skuldir_hlutf_tekjur,\n    \"Skuldir á íbúa\" = skuldir_per_ibui,\n    \"Veltufé frá rekstri sem hlutfall af tekjum\" = veltufe_hlutf_tekjur,\n    \"Veltufjárhlutfall\" = veltufjarhlutfall\n  ) |> \n  pivot_longer(\n    c(-sveitarfelag, -ar, -hluti),\n    names_to = \"name\",\n    values_to = \"y\"\n  ) |> \n  arrange(ar, hluti, sveitarfelag, name) |> \n  mutate(\n    is_percent = ifelse(\n      name %in% percent_vars,\n      TRUE,\n      FALSE\n    )\n  )\n\nthroun_data |> \n  write_parquet(\n    \"throun_data.parquet\"\n  )\n```\n:::\n\n\n# Dreifingargögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\npercent_vars <- c(\n  \"Eiginfjárhlutfall\",\n  \"Framlegð sem hlutfall af tekjum\",\n  \"Handbært fé á íbúa\",\n  \"Launa- og launatengd gjöld sem hlutfall af gjöldum\",\n  \"Nettóskuldir sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\",\n  \"Skuldahlutfall\",\n  \"Skuldir sem hlutfall af tekjum\",\n  \"Veltufé frá rekstri sem hlutfall af tekjum\",\n  \"Veltufjárhlutfall\"\n)\n\ndreifing_data <- d |> \n  select(\n    ar,\n    sveitarfelag,\n    hluti,\n    # \"Heildarskuldir\" = heildarskuldir,\n    # \"Eignir\" = eignir,\n    # \"Tekjur\" = tekjur,\n    # \"Rekstrarniðurstaða\" = rekstrarnidurstada,\n    \"Eiginfjárhlutfall\" = eiginfjarhlutfall,\n    \"Framlegð sem hlutfall af tekjum\" = framlegd_hlutf,\n    \"Handbært fé á íbúa\" = handbaert_fe_per_ibui,\n    \"Launa- og launatengd gjöld á íbúa\" = launagjold_per_ibui,\n    \"Launa- og launatengd gjöld sem hlutfall af gjöldum\" = launagjold_hlutf_gjold,\n    \"Nettóskuldir sem hlutfall af tekjum\" = nettoskuldir_hlutf_tekjur,\n    \"Rekstrarniðurstaða sem hlutfall af tekjum\" = rekstrarnidurstada_hlutf,\n    \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\" = rekstur_3_ar_hlutf_tekjur,\n    \"Útsvar og fasteignaskattur á íbúa\" = skattur_a_ibua,\n    \"Skuldahlutfall\" = skuldahlutfall,\n    \"Skuldir sem hlutfall af tekjum\" = skuldir_hlutf_tekjur,\n    \"Skuldir á íbúa\" = skuldir_per_ibui,\n    \"Veltufé frá rekstri sem hlutfall af tekjum\" = veltufe_hlutf_tekjur,\n    \"Veltufjárhlutfall\" = veltufjarhlutfall\n  ) |> \n  pivot_longer(\n    c(-sveitarfelag, -ar, -hluti),\n    names_to = \"name\",\n    values_to = \"y\"\n  ) |> \n  arrange(ar, hluti, sveitarfelag, name) |> \n  mutate(\n    is_percent = ifelse(\n      name %in% percent_vars,\n      TRUE,\n      FALSE\n    )\n  )\n\ndreifing_data |> \n  write_parquet(\n    \"dreifing_data.parquet\"\n  )\n\ndreifing_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 35,644 × 6\n      ar sveitarfelag      hluti   name                             y is_percent\n   <dbl> <chr>             <fct>   <chr>                        <dbl> <lgl>     \n 1  2002 Akraneskaupstaður A-hluti Eiginfjárhlutfall          5.82e-1 TRUE      \n 2  2002 Akraneskaupstaður A-hluti Framlegð sem hlutfall af…  5.08e-2 TRUE      \n 3  2002 Akraneskaupstaður A-hluti Handbært fé á íbúa         1.40e+4 TRUE      \n 4  2002 Akraneskaupstaður A-hluti Launa- og launatengd gjö…  5.78e-1 TRUE      \n 5  2002 Akraneskaupstaður A-hluti Launa- og launatengd gjö…  1.64e+5 FALSE     \n 6  2002 Akraneskaupstaður A-hluti Nettóskuldir sem hlutfal…  1.12e+0 TRUE      \n 7  2002 Akraneskaupstaður A-hluti Rekstrarniðurstaða sem h…  5.64e-2 TRUE      \n 8  2002 Akraneskaupstaður A-hluti Rekstrarniðurstaða undan… NA       TRUE      \n 9  2002 Akraneskaupstaður A-hluti Skuldahlutfall             4.18e-1 TRUE      \n10  2002 Akraneskaupstaður A-hluti Skuldir sem hlutfall af …  1.29e+0 TRUE      \n# ℹ 35,634 more rows\n```\n\n\n:::\n:::\n\n\n\n# Viðmiðsgögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvidmid_data <- d |> \n  filter(\n    ar >= 2010,\n  ) |>\n  select(\n    sveitarfelag, \n    ar, \n    hluti,\n    nettoskuldir_obs = nettoskuldir_hlutf_tekjur, \n    rekstrarnidurstada_obs = rekstur_3_ar_hlutf_tekjur, \n    framlegd_obs = framlegd_hlutf, \n    veltufe_obs = veltufe_hlutf_tekjur,\n    veltufjarhlutfall_obs = veltufjarhlutfall\n  ) |> \n  mutate(\n    framlegd_vidmid = nettoskuldir_obs/10,\n    veltufe_vidmid = nettoskuldir_obs/20,\n    rekstrarnidurstada_vidmid = 0,\n    veltufjarhlutfall_vidmid = 1,\n    nettoskuldir_vidmid = 1\n  ) |> \n  pivot_longer(c(-sveitarfelag, -ar, -hluti), names_to = c(\"name\", \"type\"), values_to = \"value\", names_sep = \"_\") |> \n  pivot_wider(names_from = type, values_from  = value) |> \n  mutate(\n    diff = obs - vidmid,\n    colour = diff > 0\n  ) \n\nvidmid_data |> \n  drop_na() |> \n  write_parquet(\n    \"vidmid_data.parquet\"\n  )\n\nvidmid_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7,890 × 8\n   sveitarfelag         ar hluti        name           obs vidmid    diff colour\n   <chr>             <dbl> <fct>        <chr>        <dbl>  <dbl>   <dbl> <lgl> \n 1 Akraneskaupstaður  2010 A-hluti      nettoskul…  1.18   1       0.182  TRUE  \n 2 Akraneskaupstaður  2010 A-hluti      rekstrarn… -0.0740 0      -0.0740 FALSE \n 3 Akraneskaupstaður  2010 A-hluti      framlegd    0.105  0.118  -0.0131 FALSE \n 4 Akraneskaupstaður  2010 A-hluti      veltufe     0.166  0.0591  0.106  TRUE  \n 5 Akraneskaupstaður  2010 A-hluti      veltufjar…  1.42   1       0.420  TRUE  \n 6 Akraneskaupstaður  2010 A og B-hluti nettoskul…  1.14   1       0.143  TRUE  \n 7 Akraneskaupstaður  2010 A og B-hluti rekstrarn… -0.0693 0      -0.0693 FALSE \n 8 Akraneskaupstaður  2010 A og B-hluti framlegd    0.0971 0.114  -0.0173 FALSE \n 9 Akraneskaupstaður  2010 A og B-hluti veltufe     0.159  0.0572  0.102  TRUE  \n10 Akraneskaupstaður  2010 A og B-hluti veltufjar…  1.50   1       0.497  TRUE  \n# ℹ 7,880 more rows\n```\n\n\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}