---
title: "Tímabundin vernd"
pagetitle: "Tímabundin vernd"
subtitle: "Hvað segja gögnin um fjölda hælisleitenda og fólksflutninga til Íslands?"
description: "Hér eru gögn um fjölda einstaklinga sem njóta tímabundinnar verndar, fjölda samþykktra verndarumsókna og fjölda umsókna í bið tekin saman úr gögnum  Eurostat."
date: "2024/01/18"
draft: true
categories:
    - stjórnmál
    - fólksflutningar
href: greinar/flottafolk/index.qmd
image: Figures/vernd_saman_2_page.png
execute: 
  eval: true
---


```{r setup}
#| include: false
library(cowplot)
library(tidyverse)
library(scales)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(readxl)
library(janitor)
library(plotly)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(cowplot)
library(scales)
library(visitalaneysluverds)
library(feather)
library(gganimate)
library(metill)
library(patchwork)
library(arrow)
library(glue)
library(eurostat)
library(hagstofa)
library(crosstalk)
library(clock)
library(ggh4x)
theme_set(theme_metill())
Sys.setlocale("LC_ALL", "is_IS.UTF-8")

update_cache <- TRUE


caption <- "Mynd eftir @bggjonsson hjá metill.is byggð á gögnum Eurostat um fólksflutninga: https://metill.is/greinar/flottafolk\nGögn og kóði: https://github.com/bgautijonsson/Metill.is/tree/master/greinar/flottafolk"

litur_island <- "#08306b"

litur_danmork <- "#e41a1c"

litur_finnland <- "#3690c0"

litur_noregur <- "#7f0000"

litur_svithjod <- "#fd8d3c"

litur_annad <- "#737373"

```


```{r data_beneficiaries}
#| eval: false
beneficiaries <- get_eurostat(
  "migr_asytpsm", 
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data"
) |>
  filter(
    sex == "T",
    age == "TOTAL",
    citizen == "TOTAL"
  ) |> 
  select(-unit, -sex, -age, -citizen) |> 
  label_eurostat()
```


```{r data_pop}
#| eval: false
pop <- get_eurostat(
  "demo_pjan",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data"
) |> 
  filter(
    age == "TOTAL",
    sex == "T"
  ) |> 
  select(-unit, -age, -sex) |> 
  label_eurostat()
```

```{r data_applicants}
#| eval: false
applicants <- get_eurostat(
  "migr_asypenctzm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data"
) |>
  janitor::remove_constant() |> 
  filter(
    age == "TOTAL",
    sex == "T",
    citizen == "TOTAL"
  ) |> 
  select(-citizen, -sex, -age) |> 
  label_eurostat()

```

```{r data_grants}
#| eval: false
grants <- get_eurostat(
  "migr_asytpfm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data"
) |> 
  filter(
    sex == "T",
    age == "TOTAL",
    citizen == "TOTAL"
  ) |> 
  select(-unit, -citizen, -sex, -age) |> 
  label_eurostat()
```

```{r data_decisions}
#| eval: false
decisions <- get_eurostat(
  "migr_asydcfstq",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data"
)  |> 
  filter(
    citizen == "TOTAL",
    sex == "T",
    age == "TOTAL",
    decision %in% c("TOTAL", "TOTAL_POS")
  ) |> 
  select(-citizen, -sex, -age, -unit) |> 
  label_eurostat() |> 
  pivot_wider(names_from = decision, values_from = values) 
```


```{r data_asylum_applicants}
#| eval: false
asylum_applicants <- get_eurostat(
  "migr_asyappctzm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    sex = "T",
    age = "TOTAL",
    asyl_app = "ASY_APP",
    citizen = "TOTAL"
  )
) |> 
  select(-sex, -age, -freq, -unit, -asyl_app, -citizen) |> 
  drop_na() |> 
  label_eurostat() |> 
  select(-asyl_app) |> 
  rename(asylum_applicants = values)
```


```{r data_merge}
#| eval: false
d <- beneficiaries |> 
  mutate(
    year = year(TIME_PERIOD)
  ) |> 
  rename(beneficiaries = values) |>
  select(-freq) |> 
  inner_join(
    pop |> 
      select(-freq) |> 
      group_by(geo) |> 
      filter(TIME_PERIOD == max(TIME_PERIOD)) |> 
      ungroup() |> 
      select(geo, pop = values),
    by = c("geo")
  ) |> 
  full_join(
    applicants |> 
      rename(applicants = values),
    by = c("geo", "TIME_PERIOD")
  ) |> 
  inner_join(
    grants |> 
      select(-freq) |> 
      rename(grants = values),
    by = c("geo", "TIME_PERIOD")
  ) |> 
  left_join(
    decisions |> 
      select(-freq) |> 
      rename(
        "total_decisions" = Total,
        "positive_decisions" = "Total positive decisions"
      ),
    by = join_by(geo, TIME_PERIOD)
  ) |> 
  left_join(
    asylum_applicants,
    by = join_by(geo, TIME_PERIOD == time)
  ) |> 
  rename(country = geo, time = TIME_PERIOD) |> 
  mutate(
    country = ifelse(str_detect(country, "Germany"), "Germany", country)
  ) |> 
  inner_join(
    metill::country_names(),
    by = "country"
  ) |> 
  select(
    -year, -country
  ) |> 
  pivot_longer(
    c(-land, -time, -pop)
  ) |> 
  group_by(land) |> 
  mutate(pop = max(pop, na.rm = T)) |> 
  ungroup() |> 
  mutate(per_pop = value / pop * 1e5)

d |> 
  write_csv("data/raw_data.csv")

d |> 
  select(-value, -pop) |> 
  pivot_wider(names_from = name, values_from = per_pop) |> 
  rename(
    "Mánuður" = time,
    "Land" = land,
    "Fjöldi með vernd" = beneficiaries,
    "Umsækjendur" = applicants,
    "Veitt vernd í mánuði" = grants
  ) |> 
  write_csv("data/timabundin_vernd.csv")
```


# Um gögnin

```{r}
d <- read_csv("data/raw_data.csv")
```


Gögn þessarar úrvinnslu koma frá [Eurostat](https://ec.europa.eu/eurostat/en/), nánar tiltekið eru þetta eftirfarandi gagnasöfn:

* Tímabundin vernd
  - [Einstaklingar sem njóta tímabundinnar verndar í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPSM/default/table?lang=en&category=migr.migr_asy.migr_asytp)
  - [Mánaðarlegur fjöldi einstaklinga sem fá veitta tímabundna vernd](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPFM/default/table?lang=en&category=migr.migr_asy.migr_asytp)
* Hæli
  - [Mánaðarlegur fjöldi umsækjenda um hæli](https://ec.europa.eu/eurostat/databrowser/view/migr_asyappctzm/default/table?lang=en)
  - [Umsækjendur í bið eftir niðurstöðu hælisumsóknar í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/TPS00190/default/table?lang=en&category=migr.migr_asy.migr_asyapp)
  
Þessari upplýsingar eru svo tengdar við [gögn um mannfjölda hvers lands](https://ec.europa.eu/eurostat/databrowser/view/demo_pjan/default/table?lang=en).

Til að auðvelda samanburð milli landa eru allar tölur sýndar sem fjöldi á hverja 100.000 íbúa hvers lands.

# Tímabundin Vernd

## Mánaðarlegar veitingar

Skoðum svo hversu mörgum er veitt hæli í hverjum mánuði.

```{r veiting}
#| eval: false

end_date <- clock::date_build(2023, 10, 1)

p1 <- d |> 
  filter(
    name == "grants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |>
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.05)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/veiting_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "grants") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.05)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/veiting_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvað er mörgum veitt hæli?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "grants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= date_build(2023, 04, 01)) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 20,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "both"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(70)),
    labels = label_date_short(),
    expand = expansion(add = c(25, 0)),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, 200), clip = "on") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/veiting_saman_2.png){.column-page}

## Einstaklingar sem njóta verndar

Hér skoðum við svo fjölda fólks í landinu sem nýtur tímabundinnar verndar hverri stundu.

```{r vernd}
#| eval: false

end_date <- clock::date_build(2023, 11, 1)

p1 <- d |> 
  filter(
    name == "beneficiaries"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/vernd_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "beneficiaries") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/vernd_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "beneficiaries") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= date_build(2023, 04, 01)) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    min.segment.length = Inf,
    direction = "y",
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(0.05),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(7),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.1)),
    guide = guide_axis_truncated(
      trunc_upper = 4000
    )
  )  +
  scale_colour_identity() +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

ggsave(
  plot = p &
    theme(
      plot.background = element_blank(),
      panel.background = element_blank()
    ),
  filename = "Figures/vernd_saman_2_page.png",
  width = 8, height = 0.621 * 8, scale = 1.3
)
```

![](Figures/vernd_saman_2.png){.column-page}

# Hæli

## Mánaðarlegur fjöldi umsókna

```{r asylum_applicants}
#| eval: false

end_date <- clock::date_build(2023, 11, 1)

p1 <- d |> 
  filter(
    name == "asylum_applicants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/asylum_applications_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(
    name == "asylum_applicants"
    ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/asylum_applicants_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar sækja flestir einstaklingar um hæli?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/asylum_applicants_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "asylum_applicants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= end_date) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # direction = "y", 
    # min.segment.length = Inf
    force = 0.1,
    force_pull = 1
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(35)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/asylum_applicants_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```


![](Figures/asylum_applicants_saman_2.png){.column-page}



## Ákvarðanir

### Samtals Ákvarðanir

```{r akvard_total}
#| eval: false

end_date <- clock::date_build(2023, 7, 1)

p1 <- d |> 
  filter(
    name == "total_decisions"
  ) |> 
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(xlim = c(0, 100), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á hverjum ársfjórðungi?",
    subtitle = "Fjöldi samkvæmt tölum frá apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/akvard_total_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "total_decisions") |>
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 100)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á hverjum ársfjórðungi?",
    subtitle = glue("Fjöldi samkvæmt tölum frá {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/akvard_total_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á hverjum ársfjórðungi?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "total_decisions") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter() |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 25),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á hverjum ársfjórðungi?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/akvard_total_saman_2.png){.column-page}



## Jákvæðar

```{r akvard_positive}
#| eval: false

end_date <- clock::date_build(2023, 7, 1)

p1 <- d |> 
  filter(
    name == "positive_decisions"
  ) |> 
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(xlim = c(0, 100), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt hæli á hverjum ársfjórðungi?",
    subtitle = "Fjöldi samkvæmt tölum frá apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/akvard_positive_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "positive_decisions") |>
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(),
    limits = c(0, 100)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt hæli á hverjum ársfjórðungi?",
    subtitle = glue("Fjöldi samkvæmt tölum frá {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/akvard_positive_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar er flestum einstaklingum veitt hæli á hverjum ársfjórðungi?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_positive_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "positive_decisions") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter() |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 25),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(n = 6),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar er flestum einstaklingum veitt hæli á hverjum ársfjórðungi?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/akvard_positive_saman_2.png){.column-page}




## Umsækjendur í bið

Fyrst skoðum við hversu margir umsækjendur eru að bíða eftir niðurstöðu í sínu máli á hverri stundu.

```{r umsaek}
#| eval: false

end_date <- clock::date_build(2023, 10, 1)

p1 <- d |> 
  filter(
    name == "applicants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/umsaek_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "applicants") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/umsaek_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "applicants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= end_date) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    direction = "y", 
    min.segment.length = Inf,
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

![](Figures/umsaek_saman_2.png){.column-page}

# Saman

## Mánaðarlegur fjöldi 

```{r combined}
#| eval: false
d1 <- d |> 
  filter(
    name %in% c("grants", "positive_decisions")
  ) |> 
  select(-value) |> 
  pivot_wider(values_from = per_pop) |> 
  mutate(
    positive_decisions = zoo::na.approx(positive_decisions, na.rm = FALSE, maxgap = 3) / 3,
    .by = land
  ) |> 
  mutate(
    total_decisions = grants + positive_decisions
  ) |> 
  select(-pop, -grants, -positive_decisions) |> 
  drop_na(total_decisions) |> 
  filter(
    time >= clock::date_build(2022, 4, 1)
  )

end_date <- clock::date_build(2023, 7, 1)

p1 <- d1 |>  
  rename(
    dags = time, 
    per_pers = total_decisions
  ) |> 
  filter(dags == min(dags)) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt annað hvort hæli eða tímabundin vernd í hverjum mánuði?",
    subtitle = "Fjöldi í apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/veiting_total_saman_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d1 |>  
  rename(
    dags = time, 
    per_pers = total_decisions
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt annað hvort hæli eða tímabundin vernd í hverjum mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/veiting_total_saman_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_total_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d1 |>  
  rename(
    dags = time, 
    value = total_decisions
  ) |> 
  select(dags, land, value) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat2 |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    direction = "y", 
    min.segment.length = Inf,
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, 250), clip = "on") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Samtals veitingar á hæli og tímabundinni vernd í hverjum mánuði",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

