---
title: "Tímabundin vernd og hælisleitendur"
pagetitle: "Tímabundin vernd og hælisleitendur"
subtitle: "Hvað segja gögnin um fjölda hælisleitenda og tímabundna vernd til Íslands?"
description: "Hér eru gögn um fjölda einstaklinga sem njóta tímabundinnar verndar eða hælis, fjölda samþykktra verndar- og hælisumsókna og fjölda umsókna í bið tekin saman úr gögnum  Eurostat."
date: "2024/01/18"
draft: true
categories:
    - stjórnmál
    - fólksflutningar
href: greinar/flottafolk/index.qmd
image: Figures/vernd_saman_2_page.png
execute: 
  eval: true
toc: true
---


```{r setup}
#| include: false
library(cowplot)
library(tidyverse)
library(scales)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(readxl)
library(janitor)
library(plotly)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(cowplot)
library(scales)
library(visitalaneysluverds)
library(feather)
library(gganimate)
library(metill)
library(patchwork)
library(arrow)
library(glue)
library(eurostat)
library(hagstofa)
library(crosstalk)
library(clock)
library(ggh4x)
theme_set(theme_metill())
source("R/make_plot.R")

update_cache <- TRUE


caption <- "Mynd eftir @bggjonsson hjá metill.is byggð á gögnum Eurostat um fólksflutninga: https://metill.is/greinar/flottafolk\nGögn og kóði: https://github.com/bgautijonsson/Metill.is/tree/master/greinar/flottafolk"

litur_island <- "#08306b"

litur_danmork <- "#e41a1c"

litur_finnland <- "#3690c0"

litur_noregur <- "#7f0000"

litur_svithjod <- "#fd8d3c"

litur_annad <- "#737373"

```


```{r data_beneficiaries}
#| eval: false
beneficiaries <- get_eurostat(
  "migr_asytpsm", 
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    sex = "T",
    age = "TOTAL",
    citizen = "TOTAL"
  )
) |>
  select(-unit, -sex, -age, -citizen) |> 
  label_eurostat()
```


```{r data_pop}
#| eval: false
pop <- get_eurostat(
  "demo_pjan",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    age = "TOTAL",
    sex = "T"
  )
) |> 
  select(-unit, -age, -sex) |> 
  label_eurostat()
```

```{r data_applicants}
#| eval: false
applicants <- get_eurostat(
  "migr_asypenctzm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    age = "TOTAL",
    sex = "T",
    citizen = c("TOTAL", "UA")
  )
) |> 
  select(-sex, -age) |> 
  janitor::remove_constant() |> 
  label_eurostat() |> 
  pivot_wider(names_from = citizen, values_from = values) |> 
  janitor::clean_names() |> 
  mutate(
    non_ukraine = total - ukraine
  ) |> 
  rename(
    applicants_ukraine = ukraine,
    applicants_total = total,
    applicants_non_ukraine = non_ukraine
  )
```

```{r data_grants}
#| eval: false
grants <- get_eurostat(
  "migr_asytpfm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    sex = "T",
    age = "TOTAL",
    citizen = "TOTAL"
  )
) |> 
  select(-unit, -citizen, -sex, -age) |> 
  label_eurostat()
```

```{r data_decisions}
#| eval: false
decisions <- get_eurostat(
  "migr_asydcfstq",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    citizen = c("TOTAL", "UA"),
    sex = "T",
    age = "TOTAL",
    decision = c("TOTAL", "TOTAL_POS")
  )
)  |> 
  select(-sex, -age, -unit, -freq) |> 
  label_eurostat() |> 
  pivot_wider(names_from = citizen, values_from = values) |> 
  mutate(values = Total - Ukraine) |> 
  select(-Total, -Ukraine) |> 
  pivot_wider(names_from = decision, values_from = values) |> 
  janitor::clean_names() |> 
  rename(total_decisions = total, positive_decisions = total_positive_decisions) |> 
  mutate(
    percent_positive_decisions = positive_decisions / total_decisions
  )

decisions <- crossing(
  time = seq.Date(
    from = min(decisions$time), 
    to = max(decisions$time), 
    by = "1 month"
  ),
  geo = unique(decisions$geo)
) |> 
  left_join(
    decisions,
    by = join_by(time, geo)
  ) |> 
  arrange(time)  |> 
  group_by(geo) |> 
  mutate_at(
    vars(total_decisions, positive_decisions, percent_positive_decisions),
    \(x) zoo::na.approx(x, na.rm = FALSE, maxgap = 5) / 3
  ) |> 
  ungroup()

```


```{r data_asylum_applicants}
#| eval: false
asylum_applicants <- get_eurostat(
  "migr_asyappctzm",
  cache = TRUE,
  update_cache = update_cache,
  cache_dir = "data",
  filters = list(
    sex = "T",
    age = "TOTAL",
    asyl_app = "ASY_APP",
    citizen = c("TOTAL", "UA")
  )
) |> 
  select(-sex, -age, -freq, -unit, -asyl_app) |> 
  drop_na() |> 
  label_eurostat() |> 
  rename(asylum_applicants = values) |> 
  pivot_wider(names_from = citizen, values_from = asylum_applicants) |> 
  janitor::clean_names() |> 
  mutate(
    non_ukr = total - ukraine
  ) |> 
  rename(
    asylum_applicants_total = total, 
    asylum_applicants_ukraine = ukraine,
    asylum_applicants_non_ukraine = non_ukr
  )
```

```{r data_gdp}
#| eval: false

gdp <- get_eurostat(
  "nama_10_gdp",
  filters = list(
    unit = "CP_MEUR",
    na_item = "B1GQ"
  )
) |> 
  select(-freq, -unit, -na_item) |>
  label_eurostat() |> 
  filter(year(time) == 2022) |> 
  select(-time) |> 
  rename(gdp = values)
```


```{r data_merge}
#| eval: false
d <- beneficiaries |> 
  mutate(
    year = year(time)
  ) |> 
  rename(beneficiaries = values) |>
  select(-freq) |> 
  inner_join(
    pop |> 
      select(-freq) |> 
      group_by(geo) |> 
      filter(time == max(time)) |> 
      ungroup() |> 
      select(geo, pop = values),
    by = c("geo")
  ) |> 
  inner_join(
    gdp,
    by = join_by(geo)
  ) |> 
  full_join(
    applicants,
    by = join_by(geo, time)
  ) |> 
  inner_join(
    grants |> 
      select(-freq) |> 
      rename(grants = values),
    by = join_by(geo, time)
  ) |> 
  left_join(
    decisions ,
    by = join_by(geo, time)
  ) |> 
  left_join(
    asylum_applicants,
    by = join_by(geo, time)
  ) |> 
  rename(country = geo) |> 
  mutate(
    country = ifelse(str_detect(country, "Germany"), "Germany", country)
  ) |> 
  inner_join(
    metill::country_names(),
    by = "country"
  ) |> 
  select(
    -year, -country
  ) |> 
  mutate(
    total_grants = grants + positive_decisions
  ) |> 
  pivot_longer(
    c(-land, -time, -pop, -gdp)
  ) |> 
  group_by(land) |> 
  mutate(pop = max(pop, na.rm = T)) |> 
  ungroup() |> 
  mutate(
    per_pop = value / pop * 1e5,
    per_gdp = value / gdp * 1e5
  )

d |> 
  write_csv("data/raw_data.csv")

d |>
  mutate(
    per_pop = if_else(name == "percent_positive_decisions", value, per_pop)
  ) |> 
  select(-value, -pop, -per_gdp) |>
  pivot_wider(names_from = name, values_from = per_pop) |> 
  select(
    "Dagsetning" = time,
    "Land" = land,
    "Fjöldi sem nýtur tímabundinnar verndar" = beneficiaries,
    "Nýjar veitingar á tímabundinni vernd" = grants,
    "Nýir umsækjendur um hæli" = asylum_applicants_non_ukraine,
    "Umsækjendur um hæli í bið eftir niðurstöðu" = applicants_non_ukraine,
    "Ákvarðanir teknar um hæli" = total_decisions,
    "Einstaklingum veitt hæli" = positive_decisions,
    "Hlutfall jákvæðra ákvarðana" = percent_positive_decisions
  ) |> 
  write_csv("data/timabundin_vernd_perpop.csv")

d |>
  mutate(
    per_gdp = if_else(name == "percent_positive_decisions", value, per_gdp)
  ) |> 
  select(-value, -pop, -per_pop) |>
  pivot_wider(names_from = name, values_from = per_gdp) |> 
  select(
    "Dagsetning" = time,
    "Land" = land,
    "Fjöldi sem nýtur tímabundinnar verndar" = beneficiaries,
    "Nýjar veitingar á tímabundinni vernd" = grants,
    "Nýir umsækjendur um hæli" = asylum_applicants_non_ukraine,
    "Umsækjendur um hæli í bið eftir niðurstöðu" = applicants_non_ukraine,
    "Ákvarðanir teknar um hæli" = total_decisions,
    "Einstaklingum veitt hæli" = positive_decisions,
    "Hlutfall jákvæðra ákvarðana" = percent_positive_decisions
  ) |> 
  write_csv("data/timabundin_vernd_pergdp.csv")
```

```{r}
#| eval: false
d <- read_csv("data/raw_data.csv")
```


# Skilgreiningar

Hér er unnið með gögn frá Eurostat, hagstofu Evrópusambandsins. Þar sem það er munur á löggjöf þar og á Íslandi er mikilvægt að hafa nokkrar skilgreiningar og þýðingar á hreinu. Hér verður notast við eftirfarandi skilgreiningar og þýðingar:

* **Tímabundin vernd (e. temporary protection):** Þetta er kallað *sameiginleg vernd vegna fjöldaflótta* í 44. grein laga um útlendinga, en *temporary protection* hjá Evrópusambandinu. Dómsmálaráðherra virkjaði þessa grein vegna fjöldaflótta frá Úkraínu í mars 2022. Hér verður notast við orðatiltækið **tímabundin vernd**.
* **Hæli (e. asylum):** Einstaklingur sem fær ekki tímabundna vernd heldur þarf að ganga í gegnum persónulegra ferli þar sem málsmeðferð þarf að skera út um hvort einstaklingur þurfi á hæli að halda. Í gögnum Útlendingastofnunar er þetta oftast kallað *efnisleg meðferð* og hefur verið ýmist verið skipt niður í flokkana *vernd*, *viðbótarvernd* og *mannúðarleyfi* í gögnum þeirra. Hér verður notast við orðið **hæli** yfir alla þessa flokka.

# Um gögnin

Gögn þessarar úrvinnslu koma frá [Eurostat](https://ec.europa.eu/eurostat/en/), nánar tiltekið eru þetta eftirfarandi gagnasöfn:

* Tímabundin vernd
- [Einstaklingar sem njóta tímabundinnar verndar í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPSM/default/table?lang=en&category=migr.migr_asy.migr_asytp)
- [Mánaðarlegur fjöldi einstaklinga sem fá veitta tímabundna vernd](https://ec.europa.eu/eurostat/databrowser/view/MIGR_ASYTPFM/default/table?lang=en&category=migr.migr_asy.migr_asytp)
* Hæli
- [Mánaðarlegur fjöldi umsækjenda um hæli](https://ec.europa.eu/eurostat/databrowser/view/migr_asyappctzm/default/table?lang=en)
- [Ákvarðanir teknar í málefnum umsækjenda um hæli](https://ec.europa.eu/eurostat/databrowser/view/migr_asydcfstq/default/table?lang=en&category=migr.migr_asy.migr_asydec)
- [Lokaákvarðanir teknar í málefnum umsækjenda um hæli eftir áfrýjun](https://ec.europa.eu/eurostat/databrowser/view/migr_asydcfina/default/table?lang=en&category=migr.migr_asy.migr_asydec)
- [Umsækjendur í bið eftir niðurstöðu hælisumsóknar í lok mánaðar](https://ec.europa.eu/eurostat/databrowser/view/TPS00190/default/table?lang=en&category=migr.migr_asy.migr_asyapp)

Þessari upplýsingar eru svo tengdar við [gögn um mannfjölda hvers lands](https://ec.europa.eu/eurostat/databrowser/view/demo_pjan/default/table?lang=en).

Til að auðvelda samanburð milli landa eru allar tölur sýndar sem fjöldi á hverja 100.000 íbúa hvers lands.


::: {.panel-tabset}

## Á mannfjölda

```{r}
#| column: page
#| cache: true
library(gt)
library(readr)
d <- read_csv("data/timabundin_vernd_perpop.csv")
d |> 
  gt() |> 
  tab_header(
    title = "Samantekt á gögnum um málefni flóttafólks",
    subtitle = "Tölur eru sýndar sem fjöldi á 100.000 íbúa móttökulands"
  ) |> 
  tab_spanner(
    label = "Á 100.000 íbúa",
    columns = 3:8
  ) |> 
  fmt_number(
    3:8, 
    decimals = 0, 
    sep_mark = ".",
    dec_mark = ","
  ) |> 
  fmt_percent(
    9,
    decimals = 2,
    sep_mark = ".",
    dec_mark = ","
  ) |> 
  fmt_date(
    1,
    date_style = "yMMM",
    locale = "is" 
  ) |> 
  opt_interactive(
    use_search = TRUE,
    use_filters = TRUE
  ) |> 
  tab_options(
    table.background.color = "#faf9f9"
  ) 
```

{{< downloadthis data/timabundin_vernd_perpop.csv dname="timebundin_vernd" label="Sækja gögn" type=primary class=downloadbutton >}}

## Á landsframleiðslu

```{r}
#| column: page
#| cache: true
library(gt)
library(readr)
d <- read_csv("data/timabundin_vernd_pergdp.csv")
d |> 
  gt() |> 
  tab_header(
    title = "Samantekt á gögnum um málefni flóttafólks",
    subtitle = "Tölur eru sýndar sem fjöldi á €100.000 landsframleiðslu móttökulands"
  ) |> 
  tab_spanner(
    label = "Á €100.000 landsframleiðslu",
    columns = 3:8
  ) |> 
   fmt_number(
    3:8, 
    decimals = 0, 
    sep_mark = ".",
    dec_mark = ","
  ) |> 
  fmt_percent(
    9,
    decimals = 2,
    sep_mark = ".",
    dec_mark = ","
  ) |> 
  fmt_date(
    1,
    date_style = "yMMM",
    locale = "is" 
  ) |> 
  opt_interactive(
    use_search = TRUE,
    use_filters = TRUE
  ) |> 
  tab_options(
    table.background.color = "#faf9f9"
  ) 
```

{{< downloadthis data/timabundin_vernd_pergdp.csv dname="timebundin_vernd" label="Sækja gögn" type=primary class=downloadbutton >}}

:::




# Tímabundin Vernd

Í þessum kafla verður aðallega fjallar um flóttafólk frá Úkraínu. Það getur verið eitthvað af flóttafólki frá öðrum löndum eftir löggjöfum hvers svæðis, en hlutdeild Úkraínsks flóttafólks er nær 100% í öllum fjöldatölum þessa flokks.

Þessi flokkur er oftast tekinn út úr sviga þegar tölur um flóttafólk eru greindar þar sem flóttafólk frá Úkraínu fær fljótari meðferð og veldur því minna álagi á innviði sem tengjast móttöku flóttafólks.

## Mánaðarlegar veitingar

Hér sjáum við tölur um hversu mörgum einstaklingum var veitt tímabundin vernd í hverjum mánuði. 



```{r veiting}
#| eval: false

end_date <- clock::date_build(2023, 10, 1)

p1 <- d |> 
  filter(
    name == "grants"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |>
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.05)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/veiting_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "grants") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.05)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/veiting_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvað er mörgum veitt hæli?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "grants") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= date_build(2023, 04, 01)) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 20,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "both"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(70)),
    labels = label_date_short(),
    expand = expansion(add = c(25, 0)),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, 200), clip = "on") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "grants",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 10, 1),
  title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  y_upper = 200,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/veiting_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "grants",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 10, 1),
  title = "Hvað er mörgum veitt tímabundin vernd í hverjum mánuði?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  y_upper = 5000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/veiting_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/veiting_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/veiting_saman_2.png){.column-page-left}

:::

## Einstaklingar sem njóta verndar

Hér sjaum við svo tölur um það hversu margir einstaklingar njóta tímabundinnar verndar hverju sinni. 

```{r vernd}
#| eval: false

end_date <- clock::date_build(2023, 11, 1)

p1 <- d |> 
  filter(
    name == "beneficiaries"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/vernd_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "beneficiaries") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.1)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/vernd_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "beneficiaries") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= date_build(2023, 04, 01)) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    min.segment.length = Inf,
    direction = "y",
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(0.05),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(7),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.1)),
    guide = guide_axis_truncated(
      trunc_upper = 4000
    )
  )  +
  scale_colour_identity() +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/vernd_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

ggsave(
  plot = p &
    theme(
      plot.background = element_blank(),
      panel.background = element_blank()
    ),
  filename = "Figures/vernd_saman_2_page.png",
  width = 8, height = 0.621 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "beneficiaries",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 10, 1),
  title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  # y_upper = 200,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/vernd_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "beneficiaries",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 10, 1),
  title = "Hvar njóta flestir einstaklingar tímabundinnar verndar?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  # y_upper = 50000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/vernd_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/vernd_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/vernd_saman_2.png){.column-page-left}

:::

# Hæli

Í þessum kafla eiga tölur við um *hæli*, það er að segja flóttafólk hvers umsóknir þurfa að fara í gegnum efnislega meðferð og úrskurður byggður á aðstæðum hvers og eins. 

Þessi flokkur er helsta ágreiningsefnið í umræðum þar sem einstaklingar í þessum hóp fá ekki sömu flýtimeðferð og einstaklingar frá Úkraínu. Því er rétt að líta helst til þessa hóps þegar skoða á álag á innviði sem tengjast móttöku flóttafólks.

## Mánaðarlegur fjöldi umsókna

Fyrst skoðum við hversu margar umsóknir um *hæli* þjóðir fá á hverjum mánuði.




```{r asylum_applicants}
#| eval: false

end_date <- clock::date_build(2023, 11, 1)

p1 <- d |> 
  filter(
    name == "asylum_applicants_non_ukraine"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.02)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/asylum_applications_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(
    name == "asylum_applicants_non_ukraine"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/asylum_applicants_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar sækja flestir einstaklingar um hæli?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/asylum_applicants_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "asylum_applicants_non_ukraine") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= end_date) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # direction = "y", 
    # min.segment.length = Inf
    force = 0.1,
    force_pull = 1
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(35)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar sækja flestir einstaklingar um hæli?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/asylum_applicants_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "asylum_applicants_non_ukraine",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 11, 1),
  title = "Hvar sækja flestir einstaklingar um hæli?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/asylum_applicants_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "asylum_applicants_non_ukraine",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 11, 1),
  title = "Hvar sækja flestir einstaklingar um hæli?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/asylum_applicants_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/asylum_applicants_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/asylum_applicants_saman_2.png){.column-page-left}

:::






## Ákvarðanir

Þjóðir fá mismargar umsóknir í hverju mánuði og því gefur að skilja að sumar þjóðir þurfa að afgreiða mál fljótar en aðrar til að ná að afgreiða málin.

### Samtals Ákvarðanir

Byrjum á að skoða hverju margar ákvarðanir eru teknar á hverjum mánuði. 

```{r akvard_total}
#| eval: false

end_date <- clock::date_build(2023, 7, 1)

p1 <- d |> 
  filter(
    name == "total_decisions"
  ) |> 
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
    subtitle = "Fjöldi í apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/akvard_total_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "total_decisions") |>
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/akvard_total_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "total_decisions") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter() |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 25),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "total_decisions",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  # y_upper = 500,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/akvard_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "total_decisions",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar eru flestar ákvarðanir um stöðu hælisleitenda teknar á mánuði?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  # y_upper = 25000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/akvard_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/akvard_total_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/akvard_total_saman_2.png){.column-page-left}

:::



## Jákvæðar

Í gögnum um ákvarðanir getum við séð hvort ákveðið var að veita einstakling hæli eða ekki. Skoðum hér fjölda veitinga, það er skoðum hversu mörgum einstaklingum var veitt hæli í hverjum mánuði.

```{r akvard_positive}
#| eval: false

end_date <- clock::date_build(2023, 7, 1)

p1 <- d |> 
  filter(
    name == "positive_decisions"
  ) |> 
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
    subtitle = "Fjöldi í apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/akvard_positive_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "positive_decisions") |>
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/akvard_positive_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_positive_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "positive_decisions") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter() |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 25),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(n = 6),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi á mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/akvard_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "positive_decisions",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  # y_upper = 200,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/akvard_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "positive_decisions",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar er flestum einstaklingum veitt hæli á mánuði?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  # y_upper = 50000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/akvard_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/akvard_positive_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/akvard_positive_saman_2.png){.column-page-left}

:::


## Hlutfall Jákvæðra

Með upplýsingum um fjölda ákvarðana og fjölda veitinga getum við svo skoðað hlutfall umsókna sem voru samþykktar.

```{r akvard_percent_positive}
#| eval: false

end_date <- clock::date_build(2023, 7, 1)

p1 <- d |> 
  filter(
    name == "percent_positive_decisions"
  ) |> 
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(),
    breaks = breaks_extended(),
    labels = label_hlutf()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvaða hlutfall umsókna um hæli er samþykkt?",
    subtitle = "Fjöldi í apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/perc_positive_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "percent_positive_decisions") |>
  drop_na() |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion()
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvaða hlutfall umsókna um hæli er samþykkt?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/percent_positive_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvaða hlutfall umsókna um hæli er samþykkt?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/percent_positive_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "percent_positive_decisions") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  filter() |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    # min.segment.length = Inf,
    direction = "y"
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 25),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(n = 6),
    labels = label_hlutf(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  )  +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Mánaðarleg hlutföll"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvaða hlutfall umsókna um hæli er samþykkt?",
    subtitle = "Sýnt sem hlutfall allra umsókna um hæli",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/percent_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "percent_positive_decisions",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvaða hlutfall umsókna um hæli er samþykkt?",
  subtitle = "Sýnt sem hlutfall allra umsókna um hæli",
  caption = caption,
  # y_upper = 200,
  number_labels = label_hlutf()
)


ggsave(
  plot = p,
  filename = "Figures/percent_positive_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```


![](Figures/percent_positive_saman_2.png){.column-page-left}


## Umsækjendur í bið

Skoðum hversu margir umsækjendur eru að bíða eftir niðurstöðu í sínu máli á hverri stundu.

```{r umsaek}
#| eval: false

end_date <- clock::date_build(2023, 10, 1)

p1 <- d |> 
  filter(
    name == "applicants_total"
  ) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == min(dags)) |> 
  drop_na(flottafjoldi) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
    subtitle = "Fjöldi í mars 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/umsaek_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d |> 
  filter(name == "applicants_total") |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/umsaek_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d |> 
  filter(name == "applicants_total") |> 
  arrange(time) |> 
  rename(
    dags = time, 
    flottafjoldi = value,
    per_pers = per_pop
  ) |>  
  # filter(dags <= end_date) |> 
  drop_na(per_pers) |> 
  select(dags, land, value = per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    direction = "y", 
    min.segment.length = Inf,
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/umsaek_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

```{r}
#| eval: false

p <- make_plot(
  plot_var = "applicants_non_ukraine",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  # y_upper = 250,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/umsaek_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "applicants_non_ukraine",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Hvar bíða flestir einstaklingar eftir niðurstöðu hælisumsóknar sinnar?",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  # y_upper = 50000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/umsaek_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/umsaek_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/umsaek_saman_2.png){.column-page-left}

:::



# Saman

Með því að leggja saman tölur um *tímabundna vernd* og *hæli* getum við skoðað heildarfjölda flóttafólks í hverju landi. Tölurnar að neðan eiga því við um flóttafólk bæði frá Úkraínu og öðrum löndum.

## Mánaðarlegur fjöldi 


```{r combined}
#| eval: false
d1 <- d |> 
  filter(
    name %in% c("grants", "positive_decisions")
  ) |> 
  select(-value) |> 
  pivot_wider(values_from = per_pop) |> 
  mutate(
    total_decisions = grants + positive_decisions
  ) |> 
  select(-pop, -grants, -positive_decisions) |> 
  drop_na(total_decisions) |> 
  filter(
    time >= clock::date_build(2022, 3, 1)
  )

end_date <- clock::date_build(2023, 7, 1)

p1 <- d1 |>  
  rename(
    dags = time, 
    per_pers = total_decisions
  ) |> 
  filter(dags == min(dags)) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(aes(yend = land, xend = 0, linewidth = linewidth), lty = 2, alpha = 0.5) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    breaks = breaks_extended(),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10, family = "Lato"),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt annað hvort hæli eða tímabundin vernd í hverjum mánuði?",
    subtitle = "Fjöldi í apríl 2022",
    caption = caption
  )


ggsave(
  plot = p1,
  filename = "Figures/veiting_total_saman_mars.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p2 <- d1 |>  
  rename(
    dags = time, 
    per_pers = total_decisions
  ) |> 
  filter(dags == end_date) |> 
  drop_na(per_pers) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth),
    land = glue("<i style='color:{colour}'>{land}</i>"),
    land = fct_reorder(land, per_pers)
  ) |> 
  ggplot(aes(per_pers, land, col = colour, size = size)) +
  geom_point() +
  geom_segment(
    aes(yend = land, xend = 0, linewidth = linewidth),
    lty = 2, 
    alpha = 0.5
  ) +
  scale_x_continuous(
    expand = expansion(c(0, 0.01)),
    limits = c(0, NA)
  ) +
  scale_colour_identity() +
  scale_size_manual(values = c(1, 3)) +
  scale_linewidth(
    range = c(0.2, 0.4)
  ) +
  theme(
    plot.margin = margin(t = 5, r = 25, b = 5, l = 5),
    axis.text.y = element_markdown(size = 10),
    legend.position = "none"
  ) +
  labs(
    x = NULL,
    y = NULL,
    title = "Hvar er flestum einstaklingum veitt annað hvort hæli eða tímabundin vernd í hverjum mánuði?",
    subtitle = glue("Fjöldi í {month(end_date, label = T, abbr = F)} {year(end_date)}"),
    caption = caption
  )

ggsave(
  plot = p2,
  filename = "Figures/veiting_total_saman_nóvember.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

p <- (p1 + labs(title = NULL, caption = NULL)) + 
  (p2 + labs(title = NULL, caption = NULL)) +
  plot_annotation(
    title = "Hvar bíða flestir einstaklingar eftir niðurstöðu umsóknar sinnar?",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_total_saman.png",
  width = 8, height = 0.5 * 8, scale = 1.3
)

plot_dat <- d1 |>  
  rename(
    dags = time, 
    value = total_decisions
  ) |> 
  select(dags, land, value) |> 
  mutate(
    colour = case_when(
      land == "Ísland" ~ litur_island,
      land == "Danmörk" ~ litur_danmork,
      land == "Finnland" ~ litur_finnland,
      land == "Noregur" ~ litur_noregur,
      land == "Svíþjóð" ~ litur_svithjod,
      TRUE ~ litur_annad
    ),
    linewidth = 1 * (land == "Ísland"),
    size = as_factor(linewidth)
  )

p3 <- plot_dat |> 
  ggplot(aes(dags, value)) +
  geom_line(
    data = plot_dat |> 
      filter(colour == litur_annad),
    aes(group = land, colour = litur_annad),
    alpha = 0.3,
    col = litur_annad
  ) +
  geom_line(
    data = plot_dat |> 
      filter(colour != litur_annad),
    aes(group = land, colour = colour),
    linewidth = 1
  ) +
  ggrepel::geom_text_repel(
    data = plot_dat |> 
      group_by(land) |> 
      filter(colour != litur_annad, dags == max(dags)) |> 
      ungroup(),
    aes(label = land, colour = colour),
    hjust = 0.1,
    nudge_x = 15,
    # box.padding = 0.1,
    direction = "y", 
    min.segment.length = Inf,
    force = 0.1,
    force_pull = 2
  ) +
  scale_x_date(
    breaks = unique(plot_dat$dags),
    limits = c(min(plot_dat$dags), max(plot_dat$dags) + days(25)),
    labels = label_date_short(),
    expand = expansion(add = 15),
    guide = guide_axis_truncated(
      trunc_lower = min(plot_dat$dags),
      trunc_upper = max(plot_dat$dags)
    )
  ) +
  scale_y_continuous(
    breaks = breaks_extended(),
    labels = label_number(accuracy = 1),
    limits = c(0, NA),
    expand = expansion(c(0, 0.01)),
    guide = guide_axis_truncated()
  ) +
  scale_colour_identity() +
  coord_cartesian(ylim = c(0, 250), clip = "on") +
  theme(
    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)
  ) +
  labs(
    x = NULL,
    y = NULL,
    subtitle = "Fjöldi eftir mánuði"
  )

p <- (
  (p1 + labs(title = NULL, caption = NULL)) + 
    (p2 + labs(title = NULL, caption = NULL))
) / 
  p3 +
  plot_annotation(
    title = "Samtals veitingar á hæli og tímabundinni vernd í hverjum mánuði",
    subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
    caption = caption
  )

ggsave(
  plot = p,
  filename = "Figures/veiting_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```




```{r}
#| eval: false

p <- make_plot(
  plot_var = "total_grants",
  scaling_var = "per_pop",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Samtals veitingar á hæli og tímabundinni vernd í hverjum mánuði",
  subtitle = "Sýnt sem fjöldi á 100.000 íbúa hvers lands",
  caption = caption,
  y_upper = 250,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_pop/veiting_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)

p <- make_plot(
  plot_var = "total_grants",
  scaling_var = "per_gdp",
  start_date = clock::date_build(2022, 3, 1),
  end_date = clock::date_build(2023, 7, 1),
  title = "Samtals veitingar á hæli og tímabundinni vernd í hverjum mánuði",
  subtitle = "Sýnt sem fjöldi á €100.000 landsframleiðslu hvers lands",
  caption = caption,
  y_upper = 5000,
  number_labels = label_number(big.mark = ".", decimal.mark = ",")
)

ggsave(
  plot = p,
  filename = "Figures/per_gdp/veiting_total_saman_2.png",
  width = 8, height = 1 * 8, scale = 1.3
)
```

::: {.panel-tabset}

#### Á mannfjölda

![](Figures/per_pop/veiting_total_saman_2.png){.column-page-left}

#### Á landsframleiðslu

![](Figures/per_gdp/veiting_total_saman_2.png){.column-page-left}

:::