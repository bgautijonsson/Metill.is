---
title: "Fermetraverð"
pagetitle: "Fermetraverð"
subtitle: "Í vinnslu"
date: "2023/12/04"
draft: true
execute:
  eval: true
categories:
    - efnahagur
    - sveitarfélög
    - fasteignaverð
href: greinar/fasteignir/index.qmd
image: map.png
twitter-card:
    image: map.png
---


```{r setup}
#| include: false
library(sf)
library(leaflet)
library(tidyverse)
library(visitalaneysluverds)
library(mapview)
library(leafsync)
library(htmltools)
```


```{r data}
#| echo: false
#| include: false
#| cache: true
d <- st_read(
  "~/Downloads/postnumer/postnumer.shp",
  options = "ENCODING=ISO-8859-10"
) |> 
  st_transform("WGS84")


for (i in seq_len(nrow(d))) {
  for (j in seq_len(length(d$geometry[[i]]))) {
    for (k in seq_len(length(d$geometry[[i]][[j]]))) {
      X <- d$geometry[[i]][[j]][[k]][, 1]
      Y <- d$geometry[[i]][[j]][[k]][, 2]
      
      d$geometry[[i]][[j]][[k]][, 1] <- Y
      d$geometry[[i]][[j]][[k]][, 2] <- X
    }
  }
}

kaupskra <- read_csv2(
  "https://frs3o1zldvgn.objectstorage.eu-frankfurt-1.oci.customer-oci.com/n/frs3o1zldvgn/b/public_data_for_download/o/kaupskra.csv", 
  locale = locale("is", encoding = "ISO-8859-10")
)

verd <- kaupskra |> 
  janitor::clean_names() |> 
  filter(
    utgdag >= Sys.time() - years(7),
    fullbuid == 1,
    onothaefur_samningur == 0,
    tegund %in% c("Fjölbýli"),
    einflm > 30,
    einflm < 200
  ) |> 
  drop_na() |> 
  mutate(
    # kaupverd = vnv_convert(kaupverd, as_date(utgdag)),
    fermverd = kaupverd / einflm,
    ar = year(utgdag)
  ) |> 
  filter(
    fermverd < quantile(fermverd, 0.99),
    fermverd > quantile(fermverd, 0.01)
  ) |> 
  summarise(
    kaupv = mean(kaupverd),
    fermverd = mean(fermverd),
    n = n(),
    .by = c(postnr, ar)
  ) |> 
  reframe(
    kaupv_breyting = kaupv[ar == 2023] / kaupv[ar == 2019],
    fermverd_breyting = fermverd[ar == 2023] / fermverd[ar == 2019],
    fermverd_breyting_hrein = fermverd[ar == 2023] - fermverd[ar == 2019],
    kaupv = kaupv[ar == 2023],
    fermverd_2023 = fermverd[ar == 2023],
    fermverd_2019 = fermverd[ar == 2019],
    n = n[ar == 2023],
    .by = postnr
  )



plot_dat <- d |> 
  left_join(
    verd,
    by = join_by(postnumer == postnr)
  ) |> 
  filter(
    str_detect(
      str_to_lower(stadur),
      "reykjav|garðab|kópav|seltjarn|hafnarf|mosfells"
    ),
    postnumer != 116
    # n > 10
  ) |> 
  mutate(
    fermverd_breyting = fermverd_breyting - 1,
    kaupv_breyting = kaupv_breyting - 1
  ) |> 
  drop_na(fermverd_breyting) |> 
  mutate(
    label = str_c(
      "Staður: ", stadur, "<br>",
      "<b>Póstnúmer: ", postnumer, "</b>", "<br>",
      "Fermetraverð (2023): ", metill::isk(1e3 * fermverd_2023, scale = 1e-3), "<br>",
      "Fermetraverð (2019): ", metill::isk(1e3 * fermverd_2019, scale = 1e-3), "<br>",
      "% Breyting: ", metill::hlutf(fermverd_breyting), "<br>",
      "Hrein Breyting: ", metill::isk(1e3 * fermverd_breyting_hrein, scale = 1e-3)
    )
  )
```


```{r}
make_plot <- function(varname, title, format) {
  pal <- colorNumeric(
    "viridis",
    domain = plot_dat$varname
  )
  
  plot_dat$value <- plot_dat[[varname]]
  
  plot_dat |> 
    leaflet() |> 
    addProviderTiles(providers$CartoDB) |> 
    addPolygons(
      weight = 1,
      opacity = 1,
      color = "grey",
      fillColor = ~ pal(value),
      fillOpacity = 0.6,
      label = ~ lapply(label, HTML),
      highlightOptions = highlightOptions(
        weight = 1.5,
        fillOpacity = 1,
        bringToFront = TRUE
      )
    ) |> 
    addLegend(
      "topright",
      pal = pal,
      values = ~ value,
      title = title,
      labFormat = format
    )
}

m5 <- make_plot(
  "fermverd_2019", 
  title = "Fermetraverð (2019)",
  format = labelFormat(
    suffix = " þús.kr",
    digits = 0
  )
)
m6 <- make_plot(
  "fermverd_2023",
  title = "Fermetraverð (2023)",
  format = labelFormat(
    suffix = " þús.kr",
    digits = 0
  )
)
m7 <- make_plot(
  "fermverd_breyting",
  title = "% breyting",
  format = labelFormat(
    suffix = " %",
    digits = 0,
    transform = \(x) 100 * x
  )
)
m8 <- make_plot(
  "fermverd_breyting_hrein",
  title = "Hrein breyting",
  format = labelFormat(
    suffix = " þús.kr",
    digits = 0
  )
)
```


```{r}
#| column: screen-inset
#| fig-asp: 2
m <- sync(m5, m6, m7, m8)
m
```

```{r}
#| eval: false
save_html(m, "map.html", libdir = "map_lib")
webshot::webshot("map.html", file = "map.png")
```

